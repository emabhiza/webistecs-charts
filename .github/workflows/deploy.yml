on:
  workflow_dispatch:
    inputs:
      trigger_action:
        description: 'Manually trigger ArgoCD sync'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: [self-hosted, linux, arm64]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install ArgoCD CLI
        run: |
          echo "Installing ArgoCD CLI..."
          mkdir -p $HOME/bin
          curl -sSL -o $HOME/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.14.4/argocd-linux-arm64
          chmod +x $HOME/bin/argocd
          echo "ArgoCD CLI installed."
          echo "Adding $HOME/bin to PATH"
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Get Latest Docker Image Tag (Docker Hub API)
        id: get_image_tag_api
        run: |
          echo "Fetching latest Docker image tag using Docker Hub API..."
          
          # Log in to Docker Hub
          echo "${{ secrets.DOCKER_HUBPAT }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          # Fetch tags using Docker Hub API
          IMAGE_NAME="emabhiza/webistecs"  # Replace with your Docker Hub repository name
          AUTH_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "'"${{ secrets.DOCKER_USERNAME }}"'", "password": "'"${{ secrets.DOCKER_HUBPAT }}"'"}' https://hub.docker.com/v2/users/login/ | jq -r .token)
          TAGS=$(curl -s -H "Authorization: JWT ${AUTH_TOKEN}" "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/?page_size=100" | jq -r '.results[].name')
          
          # Filter valid version tags, sort numerically, and get the latest one
          latest_tag=$(echo "$TAGS" | grep -oP 'v\d+\.\d+\.\d+' | sort -V | tail -n 1)
          
          if [ -z "$latest_tag" ]; then
            echo "Error: Unable to fetch the latest versioned tag."
            exit 1
          fi
          
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV
          echo "âœ… Latest Docker image tag fetched: $latest_tag"
          
      - name: Store Previous Image Tag
        id: store_old_tag
        run: |
          old_tag=$(grep 'tag:' webistecs/values.yaml | head -1 | awk '{print $2}' | tr -d '"')
          echo "Previous image tag: $old_tag"
          echo "old_tag=$old_tag" >> $GITHUB_ENV

      - name: Send Telegram Message - Deployment Started
        run: |
          START_TIME=$(date +%s)
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM__TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "'${{ secrets.TELEGRAM__CHATID }}'",
            "parse_mode": "HTML",
            "text": "ğŸš€ <b>ArgoCD Deployment!</b>\nğŸ‘¤ <b>Triggered by:</b> '${{ github.actor }}'\nğŸ·ï¸ <b>Previous Version:</b> '${{ env.old_tag }}'\nğŸ·ï¸ <b>New Target Version:</b> '${{ env.latest_tag }}'\nâ³ <b>Status:</b> In Progress..."
          }'

      - name: Update Helm Chart with Latest Docker Tag
        run: |
          echo "Updating values.yaml with new image tag..."
          sed -i 's/tag: .*/tag: "${{ env.latest_tag }}"/' webistecs/values.yaml
          echo "Updated values.yaml"

      - name: Commit and Push Changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add webistecs/values.yaml
          git commit -m "Update image tag to ${{ env.latest_tag }}"
          git push

      - name: Force Sync ArgoCD and Check for Failure
        id: argocd_sync
        continue-on-error: true
        run: |
          echo "Forcing ArgoCD sync..."
          if ! argocd app sync --force webistecs; then
            echo "sync_failed=true" >> $GITHUB_ENV
            exit 1
          fi
          echo "sync_failed=false" >> $GITHUB_ENV

      - name: Check Deployment Status in ArgoCD
        id: check_argocd_status
        run: |
          echo "Checking deployment status..."
          DEPLOYMENT_STATUS=$(argocd app get webistecs --output json | jq -r '.status.operationState.phase')

          if [[ "$DEPLOYMENT_STATUS" == "Failed" ]]; then
            echo "ArgoCD deployment failed. Image might not exist."
            echo "sync_failed=true" >> $GITHUB_ENV
            exit 1
          fi
          echo "sync_failed=false" >> $GITHUB_ENV

      - name: Send Logs on Failure (if needed)
        if: env.sync_failed == 'true'
        run: |
          LOGS=$(kubectl logs -l app=webistecs --tail=20)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM__TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "'${{ secrets.TELEGRAM__CHATID }}'",
            "parse_mode": "HTML",
            "text": "âš ï¸ <b>Deployment Failed! Logs:</b>\n<pre>'"$LOGS"'</pre>"
          }'

      - name: Rollback Image Tag if ArgoCD Sync Fails
        if: env.sync_failed == 'true'
        run: |
          echo "Rolling back to previous image tag: ${{ env.old_tag }}"
          sed -i 's/tag: .*/tag: "${{ env.old_tag }}"/' webistecs/values.yaml

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add webistecs/values.yaml
          git commit -m "Rollback: Restore image tag to ${{ env.old_tag }} due to failed ArgoCD sync"
          git push
          echo "Rollback complete."

      - name: Send Telegram Message - Deployment Status
        run: |
          END_TIME=$(date +%s)
          DEPLOY_TIME=$((END_TIME - START_TIME))

          if [[ "${{ env.sync_failed }}" == "true" ]]; then
            MESSAGE="âŒ <b>ArgoCD Deployment Failed!</b>\nğŸ‘¤ <b>Triggered by:</b> '${{ github.actor }}'\nğŸ“¦ <b>Application:</b> Webistecs\nğŸ·ï¸ <b>Attempted Version:</b> '${{ env.latest_tag }}'\nğŸš¨ <b>Status:</b> Rollback Complete"
          else
            MESSAGE="âœ… <b>ArgoCD Deployment Successful!</b>\nğŸ‘¤ <b>Deployed by:</b> '${{ github.actor }}'\nğŸ“¦ <b>Application:</b> Webistecs\nğŸ·ï¸ <b>Previous Version:</b> '${{ env.old_tag }}'\nğŸ·ï¸ <b>New Version:</b> '${{ env.latest_tag }}'\nâ³ <b>Deployment Time:</b> '${DEPLOY_TIME} sec'\nğŸš€ <b>Status:</b> Success!"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM__TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "'${{ secrets.TELEGRAM__CHATID }}'",
            "parse_mode": "HTML",
            "text": "'"$MESSAGE"'"
          }'

      - name: Debug - Store new image tag (update GitHub secret)
        if: env.sync_failed == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Updating LATEST_TAG GitHub secret..."
          gh secret set LATEST_TAG --body="${{ env.latest_tag }}"
          echo "LATEST_TAG secret updated."
