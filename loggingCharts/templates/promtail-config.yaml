apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: logging
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    clients:
      - url: http://loki.logging.svc.cluster.local:3100/loki/api/v1/push

    scrape_configs:
      - job_name: "webistecs-logs"
        static_configs:
          - targets:
              - localhost
            labels:
              job: "webistecs-logs"
              __path__: "/var/log/containers/webistecs-*.log"

        pipeline_stages:
          - regex:
              expression: "^(?P<container>[^-]+)-(?P<container_id>[^_]+)_(?P<pod>[^_]+)_(?P<namespace>[^_]+)_[^.]+\\.log$"
              source: __path__
              target: filename_data

          - labels:
              pod: '{{ if and .filename_data .filename_data.pod }}{{ .filename_data.pod }}{{ else }}unknown{{ end }}'
              namespace: '{{ if and .filename_data .filename_data.namespace }}{{ .filename_data.namespace }}{{ else }}unknown{{ end }}'
              container: '{{ if and .filename_data .filename_data.container }}{{ .filename_data.container }}{{ else }}unknown{{ end }}'

          - multiline:
              firstline: '^\S.*(Exception|Error|Trace):|^\d{4}-\d{2}-\d{2}T.* (INF|ERR|WRN|FTL)'
              max_wait_time: 10s
              max_lines: 500
              continue_through: '^\s+at\s|\s+---\s'
