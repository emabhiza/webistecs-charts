apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: logging
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    clients:
      - url: http://loki.logging.svc.cluster.local:3100/loki/api/v1/push

    scrape_configs:
      - job_name: "webistecs-logs"
        static_configs:
          - targets:
              - localhost
            labels:
              job: "webistecs-logs"
              __path__: "/var/log/containers/webistecs-*.log"

        pipeline_stages:
          - json:
              expressions:
                timestamp: '@["@t"]'
                level: '@["@l"]'
                message: '@["@mt"]'
                exception: '@["@x"]'
                application: Application
                machine: MachineName
                environment: EnvironmentName
                thread_id: ThreadId
                process_id: ProcessId
                process_name: ProcessName
                source_context: SourceContext
                event_id: 'EventId.Id'

          - labels:
              level:
              application:
              machine:
              environment:
              thread_id:
              process_id:
              process_name:
              source_context:
              event_id:

          - timestamp:
              source: timestamp
              format: RFC3339Nano

          - multiline:
              firstline: '^\{'
              max_wait_time: 10s
              max_lines: 500